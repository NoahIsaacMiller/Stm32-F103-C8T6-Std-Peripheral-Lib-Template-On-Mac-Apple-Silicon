#!/bin/bash

# STM32F103C8T6 é¡¹ç›®ç®¡ç†å·¥å…· ğŸ› ï¸
# åŠŸèƒ½ï¼šæ”¯æŒå¤šå‘½ä»¤è¿ç»­æ‰§è¡Œï¼Œå«æ¸…ç©ºå±å¹•åŠŸèƒ½

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # é‡ç½®é¢œè‰²

# é¡¹ç›®é…ç½®
PROJECT_NAME="STM32-F103-C8T6"
BUILD_DIR="build"
FIRMWARE_BIN="${BUILD_DIR}/firmware.bin"
FIRMWARE_ELF="${BUILD_DIR}/${PROJECT_NAME}.elf"
FLASH_ADDR="0x08000000"
SCRIPT_NAME=$(basename "$0")

# æ—¥å¿—å‡½æ•°(å¢å¼ºè§†è§‰åŒºåˆ†)
log_info() {
    echo -e "${BLUE}â„¹ï¸  ${NC}$1"
}

log_success() {
    echo -e "${GREEN}âœ…  ${NC}${BOLD}$1${NC}"
}

log_warn() {
    echo -e "${YELLOW}âš ï¸  ${NC}$1"
}

log_error() {
    echo -e "${RED}âŒ  ${NC}${BOLD}$1${NC}" >&2
}

# æ¸…ç©ºå±å¹•
cmd_clear() {
    # æ£€æµ‹ç»ˆç«¯ç±»å‹ï¼Œä½¿ç”¨å¯¹åº”æ¸…å±å‘½ä»¤
    if command -v clear &>/dev/null; then
        clear
    elif command -v cls &>/dev/null; then
        cls
    else
        # å…¼å®¹æ— æ¸…å±å‘½ä»¤çš„ç¯å¢ƒï¼Œè¾“å‡ºå¤šè¡Œç©ºç™½
        printf "\n%.0s" {1..50}
    fi
    return 0
}

# æ£€æŸ¥ç¯å¢ƒ(å·¥å…·ã€é¡¹ç›®ç»“æ„)
cmd_check() {
    log_info "æ­£åœ¨æ£€æŸ¥å¼€å‘ç¯å¢ƒ ğŸ§"
    
    # æ£€æŸ¥å¿…è¦å·¥å…·
    local tools=("arm-none-eabi-gcc" "cmake" "make" "st-flash")
    local missing=()
    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            missing+=("$tool")
        fi
    done
    if [ ${#missing[@]} -ne 0 ]; then
        log_error "ç¼ºå°‘å¿…è¦å·¥å…·ï¼š${missing[*]} ğŸ›‘"
        log_info "å®‰è£…å»ºè®®ï¼š"
        log_info "  - arm-none-eabi-gcc: brew install arm-none-eabi-gcc ğŸ§°"
        log_info "  - stlink (å«st-flash): brew install stlink ğŸ”—"
        log_info "  - cmake: brew install cmake ğŸ”¨"
        return 1
    fi
    
    # æ£€æŸ¥é¡¹ç›®ç»“æ„
    local required_files=("CMakeLists.txt" "src")
    local missing_files=()
    for file in "${required_files[@]}"; do
        if [ ! -e "$file" ]; then
            missing_files+=("$file")
        fi
    done
    if [ ${#missing_files[@]} -ne 0 ]; then
        log_error "é¡¹ç›®ç»“æ„ä¸å®Œæ•´ï¼Œç¼ºå°‘ï¼š${missing_files[*]} ğŸ“"
        log_info "è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œæ­¤è„šæœ¬ ğŸ“"
        return 1
    fi
    
    log_success "ç¯å¢ƒæ£€æŸ¥é€šè¿‡ âœ¨"
    return 0
}

# æ¸…ç†æ„å»ºäº§ç‰©
cmd_clean() {
    log_info "æ­£åœ¨æ¸…ç†æ„å»ºæ–‡ä»¶ ğŸ§¹"
    if [ -d "$BUILD_DIR" ]; then
        if [ "$(ls -A "$BUILD_DIR" 2>/dev/null)" ]; then
            rm -rf "$BUILD_DIR"
            log_info "å·²åˆ é™¤æ„å»ºç›®å½•ï¼š$BUILD_DIR ğŸ—‘ï¸"
        else
            log_info "æ„å»ºç›®å½•ä¸ºç©ºï¼Œæ— éœ€æ¸…ç† ğŸ“¦"
        fi
    else
        log_info "æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç† ğŸš«"
    fi
    log_success "æ¸…ç†å®Œæˆ ğŸŒŸ"
    return 0
}

# ç¼–è¯‘é¡¹ç›®(å«é…ç½®)
cmd_build() {
    log_info "å¼€å§‹ç¼–è¯‘é¡¹ç›® ğŸ—ï¸"
    mkdir -p "$BUILD_DIR" || {
        log_error "æ— æ³•åˆ›å»ºæ„å»ºç›®å½•ï¼š$BUILD_DIR ğŸš«"
        return 1
    }
    cd "$BUILD_DIR" || {
        log_error "æ— æ³•è¿›å…¥æ„å»ºç›®å½•ï¼š$BUILD_DIR ğŸš«"
        return 1
    }
    
    log_info "æ­£åœ¨é…ç½®CMake âš™ï¸"
    if cmake --version | grep -q "cmake version"; then
        if ! cmake ..; then
            log_error "CMakeé…ç½®å¤±è´¥ âŒ"
            cd .. && return 1
        fi
    else
        log_error "CMakeå‘½ä»¤å¼‚å¸¸ ğŸš«"
        cd .. && return 1
    fi
    
    local jobs
    if jobs=$(nproc 2>/dev/null); then
        :
    elif jobs=$(sysctl -n hw.ncpu 2>/dev/null); then
        :
    else
        jobs=4
        log_warn "æ— æ³•æ£€æµ‹CPUæ ¸å¿ƒæ•°ï¼Œä½¿ç”¨é»˜è®¤4çº¿ç¨‹ç¼–è¯‘ ğŸ§µ"
    fi
    log_info "ä½¿ç”¨ $jobs çº¿ç¨‹ç¼–è¯‘ ğŸ’»"
    if ! make -j"$jobs"; then
        log_error "ç¼–è¯‘å¤±è´¥ âŒ"
        cd .. && return 1
    fi
    
    cd .. || return 1
    
    log_info "å›ºä»¶ä¿¡æ¯ ğŸ“Š"
    if [ -f "$FIRMWARE_ELF" ]; then
        arm-none-eabi-size "$FIRMWARE_ELF" | awk '
            NR==1 {printf "  %-6s %-6s %-6s %-6s %-6s %s\n", $1, $2, $3, $4, $5, $6}
            NR==2 {printf "  %-6d %-6d %-6d %-6d %-6x %s\n", $1, $2, $3, $4, $5, $6}
        '
    else
        log_warn "æœªæ‰¾åˆ°ELFæ–‡ä»¶ï¼Œå¯èƒ½ç¼–è¯‘ä¸å®Œæ•´ âš ï¸"
    fi
    log_success "ç¼–è¯‘å®Œæˆ -> è¾“å‡ºæ–‡ä»¶ï¼š$FIRMWARE_BIN ğŸ¯"
    return 0
}

# çƒ§å½•å›ºä»¶åˆ°è®¾å¤‡
cmd_flash() {
    log_info "å‡†å¤‡çƒ§å½•å›ºä»¶ ğŸ“¤"
    
    if [ ! -f "$FIRMWARE_BIN" ]; then
        log_error "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼š$FIRMWARE_BIN ğŸš«"
        log_info "è¯·å…ˆæ‰§è¡Œ ${BOLD}${SCRIPT_NAME} build${NC} ç¼–è¯‘é¡¹ç›® ğŸ”¨"
        return 1
    fi
    
    log_info "æ£€æŸ¥ST-Linkè¿æ¥ ğŸ”Œ"
    if ! st-info --probe &>/dev/null; then
        log_warn "æœªæ£€æµ‹åˆ°ST-Linkè®¾å¤‡ï¼Œå°è¯•ç›´æ¥çƒ§å½•... ğŸ“¡"
    fi
    
    log_info "æ­£åœ¨çƒ§å½•åˆ°åœ°å€ $FLASH_ADDR ğŸ“¡"
    if st-flash write "$FIRMWARE_BIN" "$FLASH_ADDR"; then
        log_success "å›ºä»¶å·²æˆåŠŸçƒ§å½•åˆ°STM32F103C8T6 ğŸ‰"
    else
        log_error "çƒ§å½•å¤±è´¥ âŒ"
        log_info "æ’æŸ¥å»ºè®®ï¼š"
        log_info "  1. æ£€æŸ¥ST-Linkä¸å¼€å‘æ¿è¿æ¥ ğŸ”—"
        log_info "  2. ç¡®è®¤å¼€å‘æ¿ä¾›ç”µæ­£å¸¸ ğŸ”‹"
        log_info "  3. å°è¯•å…ˆæ‰§è¡Œ ${BOLD}${SCRIPT_NAME} reset${NC} é‡ç½®è®¾å¤‡ ğŸ”„"
        return 1
    fi
    return 0
}

# é‡ç½®è®¾å¤‡
cmd_reset() {
    log_info "é‡ç½®STM32è®¾å¤‡ ğŸ”„"
    if st-flash reset; then
        log_success "è®¾å¤‡é‡ç½®æˆåŠŸ ğŸ”„"
    else
        log_warn "é‡ç½®å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š"
        log_warn "  - è®¾å¤‡æœªè¿æ¥æˆ–ä¾›ç”µå¼‚å¸¸ ğŸ”‹"
        log_warn "  - ST-Linké©±åŠ¨é—®é¢˜ ğŸ–¥ï¸"
        return 1
    fi
    return 0
}

# å®Œæ•´æµç¨‹(æ¸…ç†->ç¼–è¯‘->çƒ§å½•)
cmd_full() {
    log_info "${BOLD}å¼€å§‹å®Œæ•´å¼€å‘æµç¨‹... ğŸš€${NC}"
    log_info "æ­¥éª¤ï¼šæ£€æŸ¥ç¯å¢ƒ â†’ æ¸…ç† â†’ ç¼–è¯‘ â†’ çƒ§å½• ğŸ“"
    cmd_check && \
    cmd_clean && \
    cmd_build && \
    cmd_flash && \
    log_success "å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼ğŸ‰"
    return $?
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo -e "${BOLD}STM32F103C8T6 é¡¹ç›®ç®¡ç†å·¥å…· ğŸ› ï¸${NC}"
    echo "æ”¯æŒå¤šå‘½ä»¤è¿ç»­æ‰§è¡Œï¼Œä¾‹å¦‚: ${SCRIPT_NAME} clear build flash"
    echo
    echo -e "${BOLD}ç”¨æ³•ï¼š${NC}${SCRIPT_NAME} <å‘½ä»¤1> [å‘½ä»¤2] [å‘½ä»¤3] ..."
    echo
    echo -e "${BOLD}å‘½ä»¤åˆ—è¡¨ï¼š${NC}"
    echo "  clear     ğŸ§¼ æ¸…ç©ºå±å¹•"
    echo "  check     ğŸ§ æ£€æŸ¥å¼€å‘ç¯å¢ƒ(å¿…å¤‡å·¥å…·å’Œé¡¹ç›®ç»“æ„)"
    echo "  clean     ğŸ§¹ æ¸…ç†æ„å»ºç›®å½•åŠä¸­é—´æ–‡ä»¶"
    echo "  build     ğŸ—ï¸ ç¼–è¯‘é¡¹ç›®å¹¶ç”Ÿæˆå›ºä»¶(.elfå’Œ.bin)"
    echo "  flash     ğŸ“¤ å°†å›ºä»¶çƒ§å½•åˆ°STM32è®¾å¤‡"
    echo "  reset     ğŸ”„ é‡ç½®STM32è®¾å¤‡"
    echo "  full      ğŸš€ æ‰§è¡Œå®Œæ•´æµç¨‹(check â†’ clean â†’ build â†’ flash)"
    echo "  help      â„¹ï¸ æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo
    echo -e "${BOLD}ç¤ºä¾‹ï¼š${NC}"
    echo "  ${SCRIPT_NAME} clear                # ğŸ§¼ ä»…æ¸…ç©ºå±å¹•"
    echo "  ${SCRIPT_NAME} clear full           # ğŸ§¼â†’ğŸš€ æ¸…ç©ºå±å¹•åæ‰§è¡Œå®Œæ•´æµç¨‹"
    echo "  ${SCRIPT_NAME} clear clean build    # ğŸ§¼â†’ğŸ§¹â†’ğŸ—ï¸ æ¸…ç©º+æ¸…ç†+ç¼–è¯‘"
    return 0
}

# ä¸»é€»è¾‘ï¼šæ”¯æŒå¤šå‘½ä»¤è¿ç»­æ‰§è¡Œ
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi

    local exit_code=0
    for cmd in "$@"; do
        log_info "${BOLD}===== æ‰§è¡Œå‘½ä»¤: $cmd =====${NC}"
        case "$cmd" in
            clear)  cmd_clear ;;
            check)  cmd_check ;;
            clean)  cmd_clean ;;
            build)  cmd_check; cmd_build ;;
            flash)  cmd_flash ;;
            reset)  cmd_reset ;;
            full)   cmd_full ;;
            help)   show_help ;;
            *)
                log_error "æœªçŸ¥å‘½ä»¤ï¼š$cmd ğŸš«"
                show_help
                exit 1
                ;;
        esac
        local current_code=$?
        if [ $current_code -ne 0 ]; then
            exit_code=$current_code
            log_warn "å‘½ä»¤ $cmd æ‰§è¡Œå¤±è´¥ï¼Œå·²åœæ­¢åç»­æ‰§è¡Œ âš ï¸"
            break
        fi
    done

    if [ $exit_code -ne 0 ]; then
        log_error "éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¤±è´¥ (é”™è¯¯ç : $exit_code) â—"
    fi
    exit $exit_code
}

main "$@"